version: "3.8"

services:
  auth:
    container_name: auth
    image: auth
    hostname: rakhsas.com
    build:
      context: ./auth
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./auth:/app
      - node_modules_auth:/app/node_modules
    networks:
      - backend
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.services.auth.loadbalancer.server.port=3000'
      - 'traefik.http.routers.auth.rule=Host(`rakhsas.com`) && PathPrefix(`/auth`)'
      - 'traefik.http.routers.auth.entrypoints=web'
      - "traefik.http.routers.auth.middlewares=auth-prefix"
      - "traefik.http.middlewares.auth-prefix.stripprefix.prefixes=/auth"
  frontend:
    container_name: frontend
    image: frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "4200:4200"
    depends_on:
      - auth
    networks:
      - backend
    volumes:
      - ./frontend:/app
      - node_modules_front:/app/node_modules
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.services.frontend.loadbalancer.server.port=4200'
      - 'traefik.http.routers.frontend.rule=Host(`rakhsas.com`) && PathPrefix(`/front`)'
      - 'traefik.http.routers.frontend.entrypoints=web'
      - "traefik.http.routers.frontend.middlewares=frontend-prefix"
      - "traefik.http.middlewares.frontend-prefix.stripprefix.prefixes=/front"

  chat:
    container_name: chat
    image: chat                                           
    hostname: rakhsas.com
    build:
      context: ./chat
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    depends_on:
      - auth
    networks:
      - backend
    dns:
      - 8.8.8.8
    env_file: ./.env
    volumes:
      - ./chat:/app
      - node_modules_chat:/app/node_modules
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.chat.rule=Host(`rakhsas.com`) && PathPrefix(`/chat`)'
      - 'traefik.http.services.chat.loadbalancer.server.port=3001'
      - 'traefik.http.routers.chat.entrypoints=web'
      - "traefik.http.routers.chat.middlewares=chat-prefix"
      - "traefik.http.middlewares.chat-prefix.stripprefix.prefixes=/chat"

    postgres:
      container_name: postgres
      image: postgres:latest
      ports:
        - "5432:5432"
      volumes:
        - ./postgres:/app
      networks:
        - backend
      env_file: ./.env
      restart: always

    adminer:
      container_name: adminer
      image: adminer
      ports:
        - "8081:8080"
      networks:
        - backend
      restart: always

networks:
  backend:
    name: backend

volumes:
  node_modules_auth:
    name: node_modules_auth
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/woumecht/Desktop/transcendence/auth/node_modules
  node_modules_front:
    name: node_modules_front
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/woumecht/Desktop/transcendence/frontend/node_modules
  node_modules_chat:
    name: node_modules_chat
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/woumecht/Desktop/transcendence/chat/node_modules
  node_modules_profile:
    name: node_modules_profile
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/woumecht/Desktop/transcendence/profile/node_modules
